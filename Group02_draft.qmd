---
title: "Untitled"
author: "Group02"
number-sections: false
format: 
  html:
    embed-resources: true
    code-tools: true
  pdf: default
editor_options: 
  chunk_output_type: console
editor: visual
execute:
  warning: false
  message: false
output:
  pdf_document:
---

## exploratory data analysis
#hello world
We are using the given data set "dataset02", which provides data on family income and expenditure. Our aim is to analyse which household related variables influence the number of people living in a household?

```{r}
# Load package
library(tidyverse)
library(moderndive)
library(gapminder)
library(sjPlot)
library(stats)
library(jtools)
library(psych)
library(graphics)
library(ggplot2)
library(patchwork)
```

```{r}
# Upload the dataset02 and rename it as "data"
data <- read.csv("dataset02.csv")
glimpse(data)
```

```{r}
sapply(data, function(x) if(is.factor(x)) levels(x))
ggplot(data, aes(Total.Number.of.Family.members)) +
  geom_histogram()
```

Converting character variables into factor variables is convenient for analysis. We find that "Region" only have one level, so we won't use this variables to fit model.

The level of "Household.Head.Sex" is female and male. "Type.of.Household" has three different level, which are extended Family, single family and two or more nonrelated persons/members. Because of "1" of variable "Electricity" means the house have electricity and "0" means the house doesn't have electricity, we convert the count variable "Electricity" into a factor variable.

```{r}
# Convert some variables into factor variables
data$Region <- as.factor(data$Region)
data$Household.Head.Sex <- as.factor(data$Household.Head.Sex)
data$Type.of.Household <- as.factor(data$Type.of.Household)
data$Electricity <- as.factor(data$Electricity)
```

```{r}

# View variable levels
str(data)
levels(data$Region)
levels(data$Household.Head.Sex)
levels(data$Type.of.Household)
levels(data$Electricity)
```

Correlation graph except categorical variables.

```{r}
pairs.panels(data[,-c(2,4,6)],
      smooth = TRUE,
      scale = FALSE,
      density = TRUE,
      pch =21,
      lm = TRUE,
      cor = TRUE,
      jiggle = FALSE,
      factor = 2,
      hist.col = 4,
      ci = TRUE
      )
```

From the correlation graph we can see three variables most correlate
with the total number of family member:
1.Total household income
2.Total food expenditure 
3.Household head age


The graph with only strong correlate variable

```{r}
pairs.panels(data[,c(1,3,5,7)],
      smooth = TRUE,
      scale = FALSE,
      density = TRUE,
      pch =21,
      lm = TRUE,
      cor = TRUE,
      jiggle = FALSE,
      factor = 2,
      hist.col = 4,
      ci = TRUE
      )
```



Then we draw boxplots of these variables to see if there is any outliers:

1.Total food expenditure and total number of family member by household head sex.
```{r}
p1=ggplot(data, aes(x=Total.Food.Expenditure, y=Total.Number.of.Family.members, fill=Household.Head.Sex)) + 
  geom_boxplot() +
  facet_wrap(~Household.Head.Sex) +
  labs(title="Total food expenditure and total number of family member by household head sex",
       x="Total food expenditure",
       y="total number of family member")
```

2.Household head age and total number of family member by household head sex
```{r}
p2=ggplot(data, aes(x=Household.Head.Age, y=Total.Number.of.Family.members, fill=Household.Head.Sex)) + 
  geom_boxplot() +
  facet_wrap(~Household.Head.Sex) +
  labs(title="Household head age and total number of family member by household head sex",
       x="Household Head Age",
       y="total number of family member")
```

3.Total household income and total number of family member by household head sex
```{r}
p3=ggplot(data, aes(x=Total.Household.Income, y=Total.Number.of.Family.members, fill=Household.Head.Sex)) + 
  geom_boxplot() +
  facet_wrap(~Household.Head.Sex) +
  labs(title="Total household income and total number of family member by household head sex",
       x="Total Household Income",
       y="total number of family member")
```

4.House floor area and total number of family member by household head sex
```{r}
p4=ggplot(data, aes(x=House.Floor.Area, y=Total.Number.of.Family.members, fill=Household.Head.Sex)) + 
  geom_boxplot() +
  facet_wrap(~Household.Head.Sex) +
  labs(title="House floor area and total number of family member by household head sex",
       x="House floor area",
       y="total number of family member")
```

5.House age and total number of family member by household head sex
```{r}
p5=ggplot(data, aes(x=House.Age, y=Total.Number.of.Family.members, fill=Household.Head.Sex)) + 
  geom_boxplot() +
  facet_wrap(~Household.Head.Sex) +
  labs(title="House age and total number of family member by household head sex",
       x="House age",
       y="total number of family member")
```

6.Number of bedrooms and total number of family member by household head sex
```{r}
p6=ggplot(data, aes(x=Number.of.bedrooms, y=Total.Number.of.Family.members, fill=Household.Head.Sex)) + 
  geom_boxplot() +
  facet_wrap(~Household.Head.Sex) +
  labs(title="Number of bedrooms and total number of family member by household head sex",
       x="Number of bedrooms",
       y="total number of family member")
```

7.Electricity and total number of family member by household head sex
```{r}
p7=ggplot(data, aes(x=Electricity, y=Total.Number.of.Family.members, fill=Household.Head.Sex)) + 
  geom_boxplot() +
  facet_wrap(~Household.Head.Sex) +
  labs(title="Electricity and total number of family member by household head sex",
       x="Electricity",
       y="total number of family member")
```

```{r}
(p1|p2|p3)/
(p4|p5|p6)/
  p7
```

## Methodology

The response variable here is the number of people living in the household (Total.Number.of.Family.members), which is count data. So we consider using Poisson regressionï¼Œwhich is suitable for count data.

### Poisson model

We plan to select model by looking at the p-value of variable and using the stepwise model selection based on AIC. Model 1 covers all explanatory variables.

```{r}
poisson_model_1 <- glm(Total.Number.of.Family.members ~ Total.Household.Income +
                         Total.Food.Expenditure + 
                         Household.Head.Sex + 
                         Household.Head.Age + 
                         Type.of.Household + 
                         House.Floor.Area + 
                         House.Age + 
                         Number.of.bedrooms + 
                         Electricity,
                       family = "poisson", data = data)

summ(poisson_model_1)
plot(poisson_model_1)
```

From the result, we notice that P-value of house floor area is 0.77, indicating that it is not statistically significant. So we decide to eliminate this variable.

```{r}
poisson_model_2 <- glm(Total.Number.of.Family.members ~ Total.Household.Income +
                         Total.Food.Expenditure + 
                         Household.Head.Sex +
                         Household.Head.Age + 
                         Type.of.Household + 
                         House.Age + 
                         Number.of.bedrooms + 
                         Electricity,
                       family = "poisson", data = data)
summ(poisson_model_2)
```

The next step is remove the insignificant electricity variables.

```{r}
poisson_model_3 <- glm(Total.Number.of.Family.members ~ Total.Household.Income +
                         Total.Food.Expenditure + 
                         Household.Head.Sex + 
                         Household.Head.Age + 
                         Type.of.Household + 
                         House.Age + 
                         Number.of.bedrooms,
                       family = "poisson", data = data)
summ(poisson_model_3)
```

```{r}
poisson_model_4 <- glm(Total.Number.of.Family.members ~ Total.Household.Income +
                         Total.Food.Expenditure + 
                         Household.Head.Sex + 
                         Household.Head.Age + 
                         Type.of.Household + 
                         House.Age,
                       family = "poisson", data = data)
summ(poisson_model_4)
#plot(poisson_model_4)
```

AIC and BIC for each module.

```{r}
models <- list(poisson_model_1, poisson_model_2, poisson_model_3,  poisson_model_4)
model_names <- c("Model 1", "Model 2","Model 3", "Model 4")

aic_bic_df <- tibble(
  Model = model_names,
  AIC = sapply(models, AIC),
  BIC = sapply(models, BIC)
)
aic_bic_df
```

1. The assumption that the mean equals the variance
Testing for overdispersion
```{r}
dispersion_index <- sum(residuals(poisson_model_4, type = "pearson")^2) / df.residual(poisson_model_4)
print(dispersion_index)
```
If the dispersion index is significantly less than 1, this indicates that the model is not overdispersed.

2. Assumption of linear relationships
Residual Analysis: Plot the residuals of the model. A scatter plot of the residuals against the fitted values should show randomly distributed points.

```{r}
residuals <- residuals(poisson_model_2)

plot(residuals ~ fitted.values(poisson_model_2),
     xlab = "Fitted Values",
     ylab = "Residuals",
     main = "Residual Plot for model 2",
     cex=1,
     pch=20)+
abline(h=0, lty=2, col="red",lwd=3) 
```

```{r}
residuals <- residuals(poisson_model_3)

plot(residuals ~ fitted.values(poisson_model_3),
     xlab = "Fitted Values",
     ylab = "Residuals",
     main = "Residual Plot for model 3",
     cex=1,
     pch=20)+
abline(h=0, lty=2, col="red",lwd=3) 
```

```{r}
residuals <- residuals(poisson_model_4)

plot(residuals ~ fitted.values(poisson_model_4),
     xlab = "Fitted Values",
     ylab = "Residuals",
     main = "Residual Plot for model 4",
     cex=1,
     pch=20)+
abline(h=0, lty=2, col="red",lwd=3)  

```

Residuals for different variables.

Residual Plot for total household income
```{r}
poisson_THI <- glm(Total.Number.of.Family.members ~ Total.Household.Income,family = "poisson", data = data)

plot(residuals(poisson_THI) ~ fitted.values(poisson_THI),xlab = "Fitted Values",ylab = "Residuals",main = "Residual Plot for total household income",cex=1,pch=20)+

abline(h=0, lty=2, col="red",lwd=3)
```

Residual Plot for total food expenditure
```{r}
poisson_TFE <- glm(Total.Number.of.Family.members ~ Total.Food.Expenditure,family = "poisson", data = data)


plot(residuals(poisson_TFE) ~ fitted.values(poisson_TFE),xlab = "Fitted Values",ylab = "Residuals",main = "Residual Plot for total food expenditue",cex=1,pch=20)+

abline(h=0, lty=2, col="red",lwd=3)
```

Residual Plot for household head sex
```{r}
poisson_HHS <- glm(Total.Number.of.Family.members ~ Household.Head.Sex,family = "poisson", data = data)


plot(residuals(poisson_HHS) ~ fitted.values(poisson_HHS),xlab = "Fitted Values",ylab = "Residuals",main = "Residual Plot for household head sex",cex=1,pch=20)+

abline(h=0, lty=2, col="red",lwd=3)
```

Residual Plot for household head age
```{r}
poisson_HHA <- glm(Total.Number.of.Family.members ~ Household.Head.Age,family = "poisson", data = data)


plot(residuals(poisson_HHA) ~ fitted.values(poisson_HHA),xlab = "Fitted Values",ylab = "Residuals",main = "Residual Plot for household head age",cex=1,pch=20)+

abline(h=0, lty=2, col="red",lwd=3)
```

Residual Plot for type of household
```{r}
poisson_TH <- glm(Total.Number.of.Family.members ~ Type.of.Household,family = "poisson", data = data)


plot(residuals(poisson_TH) ~ fitted.values(poisson_TH),xlab = "Fitted Values",ylab = "Residuals",main = "Residual Plot for type of household",cex=1,pch=20)+

abline(h=0, lty=2, col="red",lwd=3)
```

Residual Plot for house age
```{r}
poisson_HA <- glm(Total.Number.of.Family.members ~ House.Age,family = "poisson", data = data)


plot(residuals(poisson_HA) ~ fitted.values(poisson_HA),xlab = "Fitted Values",ylab = "Residuals",main = "Residual Plot for house age",cex=1,pch=20)+

abline(h=0, lty=2, col="red",lwd=3)
```

3.The residuals are normally distributed. Check this by Q-Q plot.
```{r}
qqnorm(residuals)
qqline(residuals, col="red",lwd=2)
```

